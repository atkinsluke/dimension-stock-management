<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracking Dashboard - Dimension Print Services</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d1b3d 25%, #4a1942 50%, #2d1b3d 75%, #1e3a5f 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            color: white;
            padding: 30px 20px;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .subtitle {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0.8;
        }

        .filters-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 0.9rem;
            margin-bottom: 8px;
            opacity: 0.9;
            font-weight: 500;
        }

        input, select {
            padding: 12px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }

        select option {
            background: #2d1b3d;
            color: white;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .quick-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .quick-filter-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .quick-filter-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .quick-filter-btn.active {
            background: rgba(74, 25, 66, 0.6);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .refresh-btn {
            padding: 12px 30px;
            background: rgba(74, 25, 66, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(74, 25, 66, 0.8);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .stat-label {
            font-size: 0.95rem;
            opacity: 0.8;
        }

        .stat-sublabel {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-top: 5px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 25px;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .table-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 25px;
            overflow-x: auto;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            font-weight: 600;
            opacity: 0.9;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.3rem;
        }

        .error {
            background: rgba(220, 53, 69, 0.3);
            border: 1px solid rgba(220, 53, 69, 0.5);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .back-link {
            text-align: center;
            margin-top: 30px;
        }

        .back-link a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-size: 0.95rem;
        }

        .back-link a:hover {
            color: white;
        }

        .cost-highlight {
            color: #4ade80;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dimension Print Services</h1>
        <p class="subtitle">Time Tracking Dashboard</p>

        <div class="filters-section">
            <div class="quick-filters">
                <button class="quick-filter-btn" onclick="setQuickFilter('today', event)">Today</button>
                <button class="quick-filter-btn" onclick="setQuickFilter('week', event)">This Week</button>
                <button class="quick-filter-btn" onclick="setQuickFilter('month', event)">This Month</button>
                <button class="quick-filter-btn active" onclick="setQuickFilter('all', event)">All Time</button>
            </div>

            <div class="filters-grid">
                <div class="filter-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="filter-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate">
                </div>
                <div class="filter-group">
                    <label for="jobNumberFilter">Job Number (Optional)</label>
                    <input type="text" id="jobNumberFilter" placeholder="Enter job number">
                </div>
                <div class="filter-group">
                    <label for="operatorFilter">Operator (Optional)</label>
                    <select id="operatorFilter">
                        <option value="">All Operators</option>
                    </select>
                </div>
            </div>

            <button class="refresh-btn" onclick="loadDashboard()">üîÑ Refresh Dashboard</button>
        </div>

        <div id="errorMessage"></div>
        <div id="dashboardContent">
            <div class="loading">Click "Refresh Dashboard" to load data...</div>
        </div>

        <div class="back-link">
            <a href="index.html">‚Üê Back to Home</a>
        </div>
    </div>

    <script>
        // IMPORTANT: Replace with your Time Logging Google Apps Script URL
        const TIME_DATA_URL = 'https://script.google.com/macros/s/AKfycbwTSVE1K6zyF6kUtwUzB5EfslOHaHiCTGsFfeUy1VY-0QLih0hibuqqKHZUWBCkAi1lNQ/exec';
        
        const HOURLY_RATE = 21.50;
        let allData = [];
        let charts = {};

        // Set initial date range
        document.getElementById('endDate').valueAsDate = new Date();

        function setQuickFilter(period, event) {
            const today = new Date();
            let endDate = new Date();
            let startDate = new Date();

            document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));
            
            switch(period) {
                case 'today':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;
                case 'week':
                    startDate.setDate(today.getDate() - 7);
                    endDate = new Date(today);
                    break;
                case 'month':
                    startDate.setMonth(today.getMonth() - 1);
                    endDate = new Date(today);
                    break;
                case 'all':
                    startDate = new Date('2020-01-01');
                    endDate = new Date('2030-12-31');
                    break;
            }

            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                const buttons = document.querySelectorAll('.quick-filter-btn');
                buttons.forEach(btn => {
                    if (btn.textContent.toLowerCase().includes(period) || 
                        (period === 'all' && btn.textContent.includes('All Time'))) {
                        btn.classList.add('active');
                    }
                });
            }

            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            document.getElementById('startDate').value = formatDate(startDate);
            document.getElementById('endDate').value = formatDate(endDate);
        }

        async function loadDashboard() {
            const errorDiv = document.getElementById('errorMessage');
            const contentDiv = document.getElementById('dashboardContent');
            
            errorDiv.innerHTML = '';
            contentDiv.innerHTML = '<div class="loading">Loading data...</div>';

            try {
                const response = await fetch(TIME_DATA_URL);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                allData = data.data || [];
                
                if (allData.length === 0) {
                    contentDiv.innerHTML = '<div class="loading">No time entries found. Start logging hours!</div>';
                    return;
                }

                // Populate operator filter
                populateOperatorFilter();
                
                filterAndDisplayData();

            } catch (error) {
                console.error('Error:', error);
                errorDiv.innerHTML = `
                    <div class="error">
                        <strong>‚ö†Ô∏è Error Loading Data</strong><br>
                        ${error.message}<br><br>
                        Make sure you've set up the Google Apps Script endpoint.
                    </div>
                `;
                contentDiv.innerHTML = '';
            }
        }

        function populateOperatorFilter() {
            const operators = [...new Set(allData.map(row => row.name))].sort();
            const select = document.getElementById('operatorFilter');
            select.innerHTML = '<option value="">All Operators</option>';
            operators.forEach(op => {
                const option = document.createElement('option');
                option.value = op;
                option.textContent = op;
                select.appendChild(option);
            });
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            const parts = String(dateStr).split('/');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return new Date(dateStr);
        }

        function filterAndDisplayData() {
            const jobFilter = document.getElementById('jobNumberFilter').value.trim().toLowerCase();
            const operatorFilter = document.getElementById('operatorFilter').value;
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            endDate.setHours(23, 59, 59);

            let filteredData = allData.filter(row => {
                const rowDate = parseDate(row.date);
                if (!rowDate) return false;
                
                const matchesDate = rowDate >= startDate && rowDate <= endDate;
                const matchesJob = !jobFilter || String(row.jobnumber).toLowerCase().includes(jobFilter);
                const matchesOperator = !operatorFilter || row.name === operatorFilter;
                
                return matchesDate && matchesJob && matchesOperator;
            });

            displayDashboard(filteredData);
        }

        function displayDashboard(data) {
            if (data.length === 0) {
                document.getElementById('dashboardContent').innerHTML = '<div class="loading">No data found for selected filters.</div>';
                return;
            }

            // Calculate stats
            const totalStdHrs = data.reduce((sum, row) => sum + parseFloat(row.stdhrs || 0), 0);
            const totalOT = data.reduce((sum, row) => sum + parseFloat(row.overtime || 0), 0);
            const totalHours = totalStdHrs + totalOT;
            const totalCost = totalHours * HOURLY_RATE;

            // Hours by operator
            const operatorHours = {};
            data.forEach(row => {
                if (!operatorHours[row.name]) operatorHours[row.name] = 0;
                operatorHours[row.name] += parseFloat(row.stdhrs || 0) + parseFloat(row.overtime || 0);
            });
            const topOperator = Object.keys(operatorHours).reduce((a, b) => 
                operatorHours[a] > operatorHours[b] ? a : b, '');

            // Hours by operation
            const operationHours = {};
            data.forEach(row => {
                if (!operationHours[row.operation]) operationHours[row.operation] = 0;
                operationHours[row.operation] += parseFloat(row.stdhrs || 0) + parseFloat(row.overtime || 0);
            });

            // Hours by job
            const jobHours = {};
            data.forEach(row => {
                if (!jobHours[row.jobnumber]) jobHours[row.jobnumber] = 0;
                jobHours[row.jobnumber] += parseFloat(row.stdhrs || 0) + parseFloat(row.overtime || 0);
            });

            const contentDiv = document.getElementById('dashboardContent');
            contentDiv.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${totalHours.toFixed(1)}</div>
                        <div class="stat-label">Total Hours</div>
                        <div class="stat-sublabel">Std: ${totalStdHrs.toFixed(1)} | OT: ${totalOT.toFixed(1)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value class="cost-highlight">¬£${totalCost.toFixed(2)}</div>
                        <div class="stat-label">Total Labour Cost</div>
                        <div class="stat-sublabel">@ ¬£${HOURLY_RATE}/hr</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.length}</div>
                        <div class="stat-label">Total Entries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${topOperator.split(' ')[0]}</div>
                        <div class="stat-label">Top Operator</div>
                        <div class="stat-sublabel">${operatorHours[topOperator]?.toFixed(1)}hrs</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">Hours by Operation</div>
                        <div class="chart-container">
                            <canvas id="operationChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Standard vs Overtime</div>
                        <div class="chart-container">
                            <canvas id="hoursTypeChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">Top 10 Operators by Hours</div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="operatorChart"></canvas>
                    </div>
                </div>

                <div class="table-card">
                    <div class="chart-title">Hours by Job Number</div>
                    <table id="jobTable"></table>
                </div>

                <div class="table-card">
                    <div class="chart-title">Recent Time Entries</div>
                    <table id="recentTable"></table>
                </div>
            `;

            createOperationChart(operationHours);
            createHoursTypeChart(totalStdHrs, totalOT);
            createOperatorChart(operatorHours);
            fillJobTable(jobHours, data);
            fillRecentTable(data);
        }

        function createOperationChart(operationHours) {
            const ctx = document.getElementById('operationChart');
            if (charts.operationChart) charts.operationChart.destroy();
            
            charts.operationChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(operationHours),
                    datasets: [{
                        data: Object.values(operationHours),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    }
                }
            });
        }

        function createHoursTypeChart(stdHrs, otHrs) {
            const ctx = document.getElementById('hoursTypeChart');
            if (charts.hoursTypeChart) charts.hoursTypeChart.destroy();
            
            charts.hoursTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Standard Hours', 'Overtime'],
                    datasets: [{
                        data: [stdHrs, otHrs],
                        backgroundColor: [
                            'rgba(74, 25, 66, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    }
                }
            });
        }

        function createOperatorChart(operatorHours) {
            const ctx = document.getElementById('operatorChart');
            if (charts.operatorChart) charts.operatorChart.destroy();
            
            const sorted = Object.entries(operatorHours)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            charts.operatorChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(item => item[0]),
                    datasets: [{
                        label: 'Hours',
                        data: sorted.map(item => item[1]),
                        backgroundColor: 'rgba(74, 25, 66, 0.8)',
                        borderColor: 'rgba(255, 255, 255, 0.5)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function fillJobTable(jobHours, data) {
            const sorted = Object.entries(jobHours)
                .sort((a, b) => b[1] - a[1]);

            // Get job descriptions
            const jobDescriptions = {};
            data.forEach(row => {
                if (!jobDescriptions[row.jobnumber]) {
                    jobDescriptions[row.jobnumber] = row.projectdescription;
                }
            });

            const table = document.getElementById('jobTable');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Job Number</th>
                        <th>Description</th>
                        <th>Hours</th>
                        <th>Cost</th>
                    </tr>
                </thead>
                <tbody>
                    ${sorted.map(([job, hours]) => `
                        <tr>
                            <td>${job}</td>
                            <td>${jobDescriptions[job] || '-'}</td>
                            <td>${hours.toFixed(1)}</td>
                            <td class="cost-highlight">¬£${(hours * HOURLY_RATE).toFixed(2)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        function fillRecentTable(data) {
            const sorted = [...data].reverse().slice(0, 20);

            const table = document.getElementById('recentTable');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Operator</th>
                        <th>Job</th>
                        <th>Operation</th>
                        <th>Std Hrs</th>
                        <th>O/T</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${sorted.map(row => {
                        const total = parseFloat(row.stdhrs || 0) + parseFloat(row.overtime || 0);
                        return `
                            <tr>
                                <td>${row.date}</td>
                                <td>${row.name}</td>
                                <td>${row.jobnumber}</td>
                                <td>${row.operation}</td>
                                <td>${parseFloat(row.stdhrs || 0).toFixed(1)}</td>
                                <td>${parseFloat(row.overtime || 0).toFixed(1)}</td>
                                <td><strong>${total.toFixed(1)}</strong></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
        }

        // Set default date range
        setQuickFilter('all');
    </script>
</body>
</html>